 #include <Arduino.h>
#include <ESP32-HUB75-MatrixPanel-I2S-DMA.h>
#include <pgmspace.h> 
#include <SPIFFS.h>

#include "gfx.h"
#include "palette.h"


// 64x64 image data, packed 4-bit (2 pixels per byte)
const unsigned char image_rle[2048]   PROGMEM=  {
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x11,0x11,0x11,0x11,0x11,0x12,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x34,0x44,0x44,0x44,0x44,0x45,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x66,0x66,0x66,0x66,0x66,0x67,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x66,0x66,0x66,0x66,0x66,0x67,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x88,0x88,0x88,0x88,
  0x88,0x88,0x88,0x88,0x88,0x80,0x00,0x00,0x00,0x66,0x69,0x66,0x66,0x66,0x67,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x88,0x88,0x88,0x88,
  0x88,0x88,0x88,0x88,0x88,0x80,0x00,0x00,0x00,0x56,0x66,0x66,0x66,0x66,0x67,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x88,0x88,0x88,0x88,
  0x88,0x88,0x88,0x88,0x88,0x80,0x00,0x00,0x00,0xAB,0xBB,0x96,0x69,0x66,0x67,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x88,0x88,0x88,0x88,
  0x88,0x88,0x88,0x88,0x88,0x80,0x00,0x00,0x00,0xCC,0xCC,0x59,0x66,0x66,0x67,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xD8,0x88,0x88,0x88,0x88,0x88,
  0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0xEE,0xEE,0xEE,0xF4,0x66,0x66,0x67,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xD8,0x88,0x88,0x88,0x88,0x88,
  0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x74,0x66,0x96,0x97,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xEE,0xEE,0xEE,0xEE,0xEE,0xEE,
  0xEE,0xEE,0xEE,0xEE,0xEE,0xEE,0xEE,0xD0,0x00,0xEE,0xEE,0xF4,0x66,0x66,0x65,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC2,0x22,0x22,0x22,0x22,0x22,
  0x22,0x22,0x22,0x22,0x22,0x22,0x22,0xC0,0x00,0x22,0x22,0x33,0x33,0x33,0x33,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x33,0x33,0x33,0x33,0x33,0x33,
  0x4A,0xBB,0xBB,0xA3,0x33,0x34,0xBB,0xF0,0x00,0x33,0x33,0x33,0x33,0x33,0x33,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x33,0x33,0x33,0x33,0x33,0x33,
  0x66,0x66,0x66,0x33,0x33,0x36,0x66,0x10,0x00,0x33,0x33,0x33,0x33,0x33,0x33,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x13,0x33,0x33,0x33,0x33,0x33,
  0x69,0x66,0x69,0x33,0x33,0x36,0x64,0x20,0x00,0x33,0x33,0x33,0x33,0x33,0x33,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x13,0x33,0x33,0x33,0x33,0x33,0x33,0x33,
  0x96,0x69,0x99,0x33,0x33,0x36,0x69,0x51,0xF1,0x33,0x33,0x33,0x33,0x33,0x33,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x33,0x33,0x36,0x63,0x33,0x33,0x69,0x69,
  0x66,0x66,0x66,0x33,0x33,0x36,0x96,0x94,0xA4,0x33,0x33,0x33,0x33,0x33,0x33,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x33,0x33,0x36,0x63,0x33,0x33,0x66,0x66,
  0x66,0x66,0x96,0x33,0x33,0x36,0x66,0x66,0x66,0x33,0x33,0x33,0x33,0x33,0x33,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x33,0x33,0x36,0x93,0x33,0x33,0x33,0x33,
  0x66,0x66,0x66,0x33,0x33,0x33,0x33,0x36,0x36,0x33,0x33,0x33,0x33,0x33,0x33,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x33,0x33,0x36,0x93,0x33,0x33,0x33,0x33,
  0x63,0x66,0x66,0x66,0x66,0x33,0x33,0x36,0x99,0x66,0x66,0x66,0x63,0x33,0x33,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x33,0x33,0x36,0x93,0x33,0x33,0x33,0x33,
  0x66,0x66,0x66,0x93,0x36,0x33,0x33,0x36,0x36,0x33,0x33,0x33,0x93,0x33,0x33,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x33,0x33,0x36,0x66,0x33,0x33,0x33,0x33,
  0x63,0x66,0x69,0x96,0x66,0x33,0x33,0x36,0x66,0x66,0x66,0x66,0x63,0x33,0x33,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,
  0x66,0x66,0x69,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0xCC,0xCC,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x33,0x33,0x33,0x33,0x66,0x66,0x66,0x66,
  0x96,0x66,0x66,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x33,0x33,0x33,0x33,0x39,0x99,0x69,0x96,
  0x66,0x66,0x96,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x33,0x33,0x33,0x33,0x36,0x69,0x66,0x66,
  0x66,0x69,0x66,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x39,0x66,0x66,0x66,
  0x66,0x66,0x66,0x93,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x46,0x66,0x66,0x66,
  0x66,0x66,0x66,0x66,0x66,0x66,0x66,0x66,0x66,0x33,0x33,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x46,0x66,0x44,0x49,
  0x66,0x66,0x66,0x66,0x66,0x93,0x44,0x96,0x96,0x33,0x33,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,0x73,0x33,0x77,0x77,
  0x33,0x33,0x33,0x33,0x33,0x37,0x77,0x73,0x33,0x33,0x33,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x01,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x31,0x88,0xEC,
  0x33,0x33,0x33,0x33,0x33,0x28,0x8E,0xC3,0x33,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x03,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x31,0xD8,0xEC,
  0x33,0x33,0x33,0x33,0x33,0x18,0x8E,0xC3,0x33,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x03,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x31,0xE8,0xEC,
  0x33,0x33,0x33,0x33,0x33,0x2E,0xEE,0xC3,0x33,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0xC3,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0xCC,0xCC,
  0x22,0x23,0x33,0x33,0x33,0x3C,0xCC,0xC2,0x22,0x00,0x00,0x00,0x00,0x00,0xC8,0x00,
  0x00,0x00,0x03,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x3C,
  0xE8,0xE2,0x33,0x33,0x33,0x33,0x33,0xCE,0xEE,0x00,0x00,0x00,0x00,0x33,0x33,0x00,
  0x00,0x00,0x03,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x3C,
  0xE8,0xD2,0x33,0x33,0x33,0x33,0x33,0xCE,0x88,0x00,0x00,0x00,0x00,0x33,0x33,0x00,
  0x00,0x00,0x03,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x3C,
  0xE8,0xE1,0x33,0x33,0x33,0x33,0x33,0x2E,0x88,0x00,0x00,0x00,0x00,0x33,0x33,0x00,
  0x00,0x11,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x3C,
  0xE8,0x88,0xCC,0xCC,0xCC,0xCC,0xCC,0x88,0x88,0x00,0x00,0x00,0x00,0x33,0x33,0x00,
  0x0A,0x99,0x66,0x66,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x3C,
  0xE8,0x8E,0xEE,0xEE,0xEE,0xEE,0xEE,0xD8,0x88,0x00,0x00,0x00,0x00,0x33,0x33,0x00,
  0x00,0x66,0x99,0x96,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x3C,
  0xE8,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x00,0x00,0x00,0x00,0x33,0x33,0x00,
  0x09,0x66,0x66,0x66,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x3C,
  0xE8,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x00,0x00,0x00,0x00,0x33,0x33,0x00,
  0x04,0x66,0x66,0x69,0x93,0x33,0x70,0x00,0x00,0x08,0x88,0x88,0x33,0x31,0x88,0x88,
  0x88,0xDC,0x57,0xF8,0x88,0x88,0x8E,0x85,0x77,0x00,0x0D,0x23,0x33,0x33,0x33,0x00,
  0x00,0x66,0x96,0x66,0x66,0x69,0xF0,0x00,0x00,0x0D,0x88,0xE8,0x33,0x31,0xE8,0x88,
  0x88,0xE2,0xB9,0x68,0x88,0x88,0x8E,0xCB,0x99,0x00,0x08,0x33,0x33,0x33,0x33,0x00,
  0x04,0x99,0x69,0x66,0x94,0xA4,0xF0,0x00,0x00,0x08,0x88,0x88,0x33,0x31,0xD8,0x88,
  0x88,0xE2,0xB4,0x98,0x88,0x88,0x8E,0xCB,0x9B,0xC0,0x08,0x13,0x33,0x33,0x33,0x00,
  0x00,0x55,0xB6,0x99,0x6F,0x13,0x70,0x00,0x00,0x08,0x88,0x88,0x11,0x3C,0x88,0x88,
  0x88,0xDC,0xF1,0x18,0x88,0x88,0x8E,0x8F,0x17,0x8E,0x88,0x33,0x33,0x33,0x33,0x00,
  0x00,0x00,0x05,0x94,0xF0,0x00,0x03,0x33,0xCE,0x88,0x88,0x88,0x88,0x88,0x88,0x88,
  0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x33,0x33,0x33,0x33,0x00,
  0x00,0x00,0x05,0x69,0xF0,0x00,0xC3,0x33,0xCE,0x88,0x88,0x88,0x88,0x88,0x88,0x88,
  0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x33,0x33,0x33,0x33,0x00,
  0x00,0x00,0x06,0x4B,0xF0,0x00,0xC3,0x33,0xCE,0xEE,0x88,0x88,0x88,0x88,0x88,0x88,
  0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x33,0x33,0x33,0x33,0x00,
  0x00,0x00,0x0C,0xCC,0xCC,0xC1,0x23,0x33,0x2C,0xCC,0x88,0x88,0x88,0x88,0x88,0x88,
  0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x33,0x33,0x33,0x33,0x00,
  0x00,0x00,0x00,0x00,0x03,0x33,0x33,0x33,0x33,0x33,0x8E,0x88,0x88,0x88,0x88,0x88,
  0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x33,0x33,0x33,0x33,0x00,
  0x00,0x00,0x00,0x00,0x03,0x33,0x33,0x33,0x33,0x33,0x8E,0x88,0x88,0x88,0x88,0x88,
  0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x33,0x33,0x33,0x33,0x00,
  0x00,0x00,0x00,0x00,0x03,0x33,0x33,0x33,0x33,0x33,0x8E,0x88,0x88,0x88,0x88,0x88,
  0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x13,0x33,0x33,0x33,0x00,
  0x00,0x00,0x01,0x11,0x13,0x33,0x33,0x33,0xC8,0x88,0x88,0x88,0x88,0x88,0x88,0x88,
  0x88,0x88,0x88,0x88,0x88,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x03,0x33,0x33,0x33,0x33,0x33,0xCE,0xDE,0x88,0x88,0x88,0x88,0x88,0x88,
  0x88,0x88,0x88,0x88,0x88,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x03,0x33,0x33,0x33,0x33,0x33,0xCE,0x88,0x88,0x88,0x88,0x88,0x88,0x88,
  0x88,0x88,0x88,0x88,0x88,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x03,0x33,0x33,0x33,0x33,0x33,0xCE,0x88,0x88,0x88,0x88,0x88,0x88,0x88,
  0x88,0xD8,0xDD,0xD8,0xD8,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x03,0x33,0x30,0x00,0x00,0x00,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x80,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x03,0x33,0x30,0x00,0x00,0x00,0xD8,0x88,0x88,0x88,0x88,0x88,0x88,0x80,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x03,0x33,0x30,0x00,0x00,0x00,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x80,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x0C,0x22,0xC0,0x00,0x00,0x00,0x08,0x88,0x88,0x88,0x88,0x88,0x88,0x80,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
  
};

const uint16_t pa[16] PROGMEM = {
  0x0000,0xDD70,0xDD91,0xD4EC,0xDCCC,0xDD0D,0xDCED,0xDD2E,
  0xE71C,0xDCEC,0xD4CC,0xDCCB,0xDDD3,0xE73C,0xE73D,0xDD4F
  
};

/*
inline uint8_t getPixel(const uint8_t* buf, int idx) {
    uint8_t byte = pgm_read_byte(&buf[idx >> 1]);
    return (idx & 1) ? (byte & 0x0F) : (byte >> 4);
}

 
 uint8_t getPixel2(const unsigned char* buf, int idx) {
    return (idx & 1) ? (buf[idx >> 1] >> 4) & 0x0F : buf[idx >> 1] & 0x0F;
 }
  */  

 void logo() {
  

    for (int y = 0; y < 64; y++) {
    for (int x = 0; x < 64; x += 2) {
        int idx = (y * 64 + x) >> 1;
        uint8_t byte = pgm_read_byte(&image_rle[idx]);
        uint8_t col1 = byte >> 4;
        uint8_t col2 = byte & 0x0F;

        if (col1) GFX::setPixel(x, y, pgm_read_word(&pa[col1]));
        if (col2) GFX::setPixel(x + 1, y, pgm_read_word(&pa[col2]));
    }
}

}
 
/*
void logo2() {
  int px=0;
   int py=0;
 

    for(int y=0;y<64;y++){
        int screenY = py + y;
        if(screenY<0 || screenY>=HEIGHT) continue;

        for(int x=0;x<64;x++){
            int screenX = px + x;
            if(screenX<0 || screenX>=WIDTH) continue;

            int idx = y*64 + x;
            uint8_t col = getPixel(image_rle, idx);
                
             if(col!=0) GFX::setPixel(x, y, pa[col]);
            
        }
    }
}
 
*/
 /*
void RLEImage(int x0, int y0) {
  int x = x0, y = y0;
  size_t idx = 0;

  while (idx < sizeof(image_rle)) {
    // Read bytes from flash (PROGMEM)
    uint8_t count = pgm_read_byte(&image_rle[idx++]);
    uint8_t r = pgm_read_byte(&image_rle[idx++]);
    uint8_t g = pgm_read_byte(&image_rle[idx++]);
    uint8_t b = pgm_read_byte(&image_rle[idx++]);

    uint16_t color = rgbToPaletteIndex(r, g, b);  // or dma_display->color565(r,g,b)

    for (int i = 0; i < count; i++) {
      GFX::setPixel(x, y, color);
      x++;
      if (x >= x0 + WIDTH) {
        x = x0;
        y++;
        if (y >= y0 + HEIGHT) break;
      }
    }
  }

  SomeFix();
  updatePalette();
  GFX::fliper();
}
  */
 